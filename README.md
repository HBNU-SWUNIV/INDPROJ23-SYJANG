# 한밭대학교 SW중심대학 산학연계프로젝트 - 과제명

## **팀 구성**
### 지도교수
 - 장수영 교수님

### 기업체 
 - 김도윤 대표

### 참여학생
 - 이재윤(컴퓨터공학과)
 - 함규식(컴퓨터공학과) 
 - 한세영(컴퓨터공학과)
 - 20181586_김진우(컴퓨터공학과)
 - 20181612_김자용(컴퓨터공학과)
 - 이지형(컴퓨터공학과) 
 - 김영빈(컴퓨터공학과)

## Project Background
- ### 필요성
- 디지털 트윈은 실제 세계의 물체나 공정을 가상의 모델로 구현하고, 실시간 데이터를 수집하고 분석하여 시스템을 최적화하거나 문제를 예방할 수 있도록 하는 기술이다. 이러한 기술은 제조업에서 제품 생산 공정을 최적화하거나 결함을 예측하여 불량률을 줄일 수 있으며, 도시 관리 분야에서는 교통체증이나 대기 오염과 같은 문제를 예측하여 대응하는 등 다양한 분야에서 활용될 수 있다. 디지털 트윈이 제조업과 제품 생상 공정 과정에서 사용되기 위해서는 그 정확성과 유용성을 보장하기 위한 작업이 필요하다. 디지털 트윈의 정확한결과를 도출하기 위해서는 현실에서 많은 양의 데이터를 빠르고 정확하게 획득할 수 있는 데이터 수집기술이 보장되어야 한다. 본 프로젝트에서는 X-ray 데이터 수집을 목표로 한다. X-ray 데이터를 제품,생성공정 과정에서 활용하기 위해서는 기존 X-ray 소스와 X-ray 디텍터 간 동기화 기능, X-ray 디텍터로부터 영상을 획득할 수 있는 시스템 그리고 시스템 GUI가 필요하다는 해당 기업의 요구를 반영하여 프로젝트를  수행하고자 한다. 본 프로젝트의 결과물을 통해서 X-ray 디텍터를 통해 획득한 많은 양의 데이터를 빠르고 정확하게 획득할 수 있을 것이며, 이는 추후 컴퓨터 비전 기술에 기반한 이상 검출 등 다양한 서비스 개발에 도움이 될 것이다. 
- ### 기존 해결책의 문제점
  - 본 과제의 최종 목표는 기 개발된 X-ray 장비를 통합하여 하나의 완성된 X-ray 영상획득 
장비에 활용할 응용 소프트웨어를 개발하는 것을 목표로 함
  - X-ray 영상획득 장비는 기존의 X-ray를 생성하는 X-ray 소스 장비를 제공받아 해당 장비
를 제어함과 동시에 X-ray와 검사 대상에 입사된 X-ray 양을 측정하는 디텍터로부터 영상
데이터를 내려받아 이를 처리할 수 있도록 함
 - 따라서, X-ray 데이터를 제품, 생성, 공정 과정에서 활용하기 위해 X-ray 디덱터를 통한 데
이터를 수집해야함. 이를 수행하기 위해 X-ray 디덱터와 X-ray 소스와의 동기화가 필요함. - 해당 동기화를 바탕으로 X-ray 디덱터를 통해 영상을 획득 할 수 있는 시스템 그리고 기
업이 요구하는 시스템의 GUI를 개발하는 것이 목표임.
  
## System Design
  - ### System Requirements
    - OOO
    - OOO
    
## Case Study
  - 가. X-ray 영상획득 응용 소프트웨어 개발
    1) 목적 및 배경
      * 육안이나 카메라로 확인이 불가능한 제품 내부의 결함을 검사하는 비파괴 검사에 X-ray 장비가 활용되고 있음. 
      * 제품의 소형화 및 단순화가 진행됨에 따라 생산된 제품의 내부 검사방식으로는 검사 시간이 증가하여 전수 조사를 시도하는 것이 불가능해져 제품의 결함을 탐지 못하는 문제가 발생하고있음.
      * 이에 따라 제품의 내부를 검사할 수 있는 비파괴 검사 방법인 X-ray 기반 비파괴 검사장비를 활용한 검사 방식을 제품 품질 확보를 위해 사용되고 있음. 
      * 본 시스템은 X-ray를 통해 수집한 데이터를 활용하여 제품, 생성 공정 과정에 적용 시키는 것에 목적을 두고 있음. 이를 활용하기 위하여 기존 X-ray 소스와 X-ray 디텍터 간 동기화 기능, X-ray 디텍터로부터 영상을 획득할 수 있는 시스템 그리고 기업의 요구를 반영한 GUI를 개발함. 
  
    2) 시스템 구현
      가) X-ray 소스제어
      * 분산 응용 프로그램을 위한 소켓 기반 메시징 라이브러리 중, ZeroMQ의 .NET 바인딩인 NetMQ를 사용하여 서로 다른 환경에서의 데이터 통신을 제공. 
      * NetMQ의 Publisher-Subscribe 패턴을 통해 해당 소켓을 구독하는 여러 수신자에게 동시적으로 특정 데이터(영상 촬영 시간, 촬영 대기 시간 등)을 전달.
      * Router-Dealer 패턴을 통해 여러 사용자에게서 소켓을 통해 전달되는 메시지(x-ray 촬영 등)를 동시에 수신하고, 이를 Poller를 통해 관리. 
      * NetMQ에서 여러 소켓을 효율적으로 관리하기 위해서 제공되는 Poller를 통해 각각의 서로 다른 사용자 소켓에서 발생하는 이벤트(메시지 송·수신 등)를 모니터링하여, 비동기적으로 처리 프로세스를 제공하여 동시성을 보장함. 
      * 사용자에 해당하는 “Paster”가 “x-ray 단말기 촬영” 등의 메시지를 관리자에 해당하는 “Taurus”에게 전달하면, 이를 비동기적으로 처리하는 기능을 제공. 
  
      나) X-ray 디텍터 제어
      * Serial Port에 연결되어있는 x-ray 단말기에 Arduino를 통해 전기적 신호를 전달하여 x-ray 영상 촬영을 진행.
      * 촬영된 영상 파일을 저장하고, 이를 사용자에게 NetMQ 소켓 통신을 통해 전달하여 결과를 도출.

      다) X-ray 소스 및 디텍터 제어
      *  NetMQ의 Router-Dealer 패턴을 통해 여러 사용자에게서 x-ray 제어를 위한 메시지를 동시에 수신함
      *  Poller를 통해 여러 사용자 소켓을 효율적으로 관리하고, 소켓에서 발생하는 이벤트를 모니터링 하여 비동기적으로 처리하여 동시성을 보장함
      *  x-ray 제어 관련 메시지를 수신하면, 이를 Serial Port에 연결되어있는 실제 x-ray 단말기에 Arduino를 통해 전기적 신호를 전달하여 x-ray 단말기를 제어함
      *  NetMQ 소켓 통신을 통해 저장된 영상 파일을 사용자에게 전달함 

      라) 시스템 GUI 구현
      * X-ray 소스 및 X-ray 디텍터 동기화 소프트웨어 GUI 개발을 위한 C# 기반 Windows Forms 방식 GUI 개발
      * 동기화된 소프트웨어와의 통신을 위한 NetMQ 기반의 통신 방식을 사용.
      * 데이터 수집 소프트웨어의 동기화 진행과정에 대한 필수 과정들을 Button기반의 GUI를 통하여 시각화함.
      * 비동기 방식의 네트워크 통신을 통하여 각 디바이스에 대한 연결을 관리하고, TCP 서버를 시작하여 클라이언트에게 기준 값에 대한 내용을 전달함.
      * 이후 네트워크에서 “PreAcq” 메시지를 디바이스에 전송후 데이터 수신시, “AckImage”메시지를 기준으로 이미지 데이터를 처리하고 저장하는 역할을 수행함.

  - 나. X-ray 영상 기반 이상 검출 시스템 개발
    1) 목적 및 배경
      *  본 시스템 개발의 주된 목적은 이상이 있는 제품을 탐지하기 위한 것임, 이를 위해 autoencoder와 CNN 기술을 활용함 
      *  autoencoder는 입력된 데이터를 압축하여 표현한 후, 그 표현을 바탕으로 원본 데이터를 재구성하는 모델임
      *  CNN은 이미지의 지역적 특성을 학습하는 데 특화된 신경망으로, autoencoder와 결합하여 이미지 재구성 능력을 향상 시키기 위해 사용되었음

    2) 시스템 구현
      가) 모델 구조
        * CNN 기반의 인코더와 디코더로 구성된 autoencoder 모델을 사용하였음
        * 인코더의 입력 이미지의 크기는 300x300x3으로 인코더는 두 개의 Conv2D 레이어로 구성되어 있으며, 각 레이어 다음에는 MaxPooling2D 레이어가 있음
        * 첫 번째 Conv2D 레이어는 32개의 필터를 가지고 있고, 두 번째 Conv2D 레이어는 64개의 필터를 가지고 있음
        * 디코더는 세 개의 Conv2D 레이어와 두 개의 UpSampling2D 레이어로 구성되어 있음
        * 첫 번째와 두 번째 Conv2D 레이어는 각각 64개, 32개의 필터를 가지고 있고, 마지막 Conv2D 레이어는 원본 이미지와 동일한 3개의 필터를 가지고 있음
      나) 구현 방법
        * ‘정상적으로 연결된 랜선’을 나타내는 x-ray 이미지 50장과 ‘선이 끊긴 랜선’을 나타내는 x-ray 이미지 10장을 준비함
        * 정상적으로 연결된 랜선’을 나타내는 x-ray 이미지 50장 중 40장을 훈련 데이터로, 남은 10장과 ‘선이 끊긴 랜선’을 나타내는 이미지 10장을 테스트 데이터로 사용함
        * 각 이미지를 300x300의 크기로 잘랐음, TensorFlow를 이용해서 이미지를 불러오고, 그 이미지를 배열로 변환하고, 픽셀 값을 [0,1] 범위로 정규화하였고, 각 이미지를 10번 복사하여 사용하였음
        * 전처리 된 이미지 데이터를 사용하여 모델을 학습시킨 후 저장하였음
        * 학습에 사용된 주요 설정은 아래와 같음
          3.1.1.3.5.1. 옵티마이저: Adam, 손실함수: Mean Squared Error(MSE), Epochs: 50, Batch size: 10, Early Stopping: 학습 중 loss 값이 10번 연속으로 개선되지 않으면 학습을 일찍 중단함

  
  
## Conclusion
  - ###  X-ray 영상획득 응용 소프트웨어 개발
    - 수행결과
      가) 데이터 획득 소프트웨어 개발
        (1) 영상획득 응용 소프트웨어 기술을 바탕으로 데이터 수집, 저장 기능을 기존 제품에 연계하여 데이터를 수집함으로써 새로운 방식의 소프트웨어를 개발. 
        (2) X-ray 소스 제어 알고리즘 설계 및 개발을 위해 통신 지원 기술 확보하고 X-선 조사를 위한 설계 및 개발. 
        (3) X-선을 X-ray 소스로부터 X-ray 디텍터의 관전압, 관전류, 조사시간 등의 최적화된 값을 확인하고 영상을 획득할 수 있는 기술을 개발. 
        (4) X-ray 동기화를 위하여 X-ray 소스로부터 X-선을 조사한 후 X-ray 디텍터를 통해 데이터를 수집하는 구조의 응용 소프트웨어를 정립하여 데이터를 관리하도록 함.


  - ###  X-ray 영상 기반 이상 검출 시스템 개발
    - 수행 결과
      가) 저장된 autoencoder 모델을 이용해서 테스트 이미지를 재구성하였음
      나) 원본 이미지와 비교하여 재구성의 정확도를 평가함
      다) 원본 이미지와 재구성된 이미지 사이의 Mean Squared Error(MSE)를 계산하여 재구성 오차를 평가함
      라) 설정된 임계값(0.0002)를 기반으로 재구성 오차가 임계값을 초과할 경우 해당 이미지를 “이상 데이터”로 판단함 “이상 데이터”로 판단되면 위와 같은 결과 창이 뜨게 됨
      마) “이상 데이터”로 판단될 경우 원본 이미지와 재구성된 이미지를 재구성 오차율과 함께 화면에 표시됨
      바) 재구성 오차가 임계값 이하일 경우 “정상 데이터”로 판단함
  
## Project Outcome
- ### 2023년 한국전기전자학회 하계학술대회 참가
  - 지원 대상자
  - 대학원생 : 이재윤, 한세영, 김진우
